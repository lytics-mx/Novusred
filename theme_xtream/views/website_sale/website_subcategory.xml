<odoo>
    <template id="website_subcategory" name="Subcategorías con Filtros">
        <t t-call="website.layout">
            <div id="wrap" class="oe_structure oe_empty" style="font-family: 'Questrial', sans-serif;">
                <div class="container-fluid py-4">
                    <div class="row">
                        <!-- Sidebar de Filtros -->
                        <div class="col-lg-3 col-md-4">
                            <div class="filters-sidebar" style="padding: 20px;">
                                <!-- Product Count -->
                                <div class="filter-section mb-4">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span><t t-esc="product_count"/> productos</span>
                                    </div>
                                </div>

                                <!-- Categorías -->
                                <div class="filter-section mb-4">
                                    <h6 class="mb-2">Categoría</h6>
                                    <select id="category-select" class="form-select form-select-sm mb-2" onchange="updateFilters()">
                                        <option value="">Todas las categorías</option>
                                        <t t-foreach="categories" t-as="category" t-key="category.id">
                                            <option t-att-value="category.id" 
                                                    t-att-selected="'selected' if current_filters.get('category_id') == category.id else ''">
                                                <t t-esc="category.name"/>
                                            </option>
                                        </t>
                                    </select>
                                    
                                    <!-- Subcategorías -->
                                    <select id="subcategory-select" class="form-select form-select-sm" onchange="updateFilters()" 
                                            t-att-style="'display: block' if subcategories else 'display: none'">
                                        <option value="">Todas las subcategorías</option>
                                        <t t-foreach="subcategories" t-as="subcategory" t-key="subcategory.id">
                                            <option t-att-value="subcategory.id"
                                                    t-att-selected="'selected' if current_filters.get('subcategory_id') == subcategory.id else ''">
                                                <t t-esc="subcategory.name"/>
                                            </option>
                                        </t>
                                    </select>
                                </div>

                                <!-- Free Shipping Toggle -->
                                <div class="filter-section mb-4">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>Envío gratis</span>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="free-shipping" 
                                                   t-att-checked="'checked' if current_filters.get('free_shipping') else ''"
                                                   onchange="updateFilters()"/>
                                        </div>
                                    </div>
                                </div>

                                <!-- Brands (Marca) -->
                                <div class="filter-section mb-4" t-if="available_brands">
                                    <h6 class="mb-2">Marca</h6>
                                    <div class="brands-list">
                                        <t t-foreach="available_brands" t-as="brand" t-key="brand.id">
                                            <div class="mb-1">
                                                <a t-att-href="'/subcategory?' + (current_filters.get('category_id') and ('category_id=' + str(current_filters.get('category_id')) + '&amp;') or '') + (current_filters.get('subcategory_id') and ('subcategory_id=' + str(current_filters.get('subcategory_id')) + '&amp;') or '') + (current_filters.get('free_shipping') and 'free_shipping=true&amp;' or '') + 'brand_id=' + str(brand.id)" 
                                                   class="text-decoration-none small"
                                                   t-att-style="'color: #007bff; font-weight: bold;' if current_filters.get('brand_id') == brand.id else 'color: #6c757d;'">
                                                    <t t-esc="brand.name"/>
                                                    (<t t-esc="brand_counts.get(brand.id, 0)"/>)
                                                </a>
                                            </div>
                                        </t>
                                    </div>
                                </div>

                                <!-- Price Range -->
                                <div class="filter-section mb-4">
                                    <h6 class="mb-2">Precio</h6>
                                    <div class="price-options">
                                        <div class="mb-1">
                                            <a t-att-href="'/subcategory?' + (current_filters.get('category_id') and ('category_id=' + str(current_filters.get('category_id')) + '&amp;') or '') + (current_filters.get('subcategory_id') and ('subcategory_id=' + str(current_filters.get('subcategory_id')) + '&amp;') or '') + (current_filters.get('brand_id') and ('brand_id=' + str(current_filters.get('brand_id')) + '&amp;') or '') + (current_filters.get('free_shipping') and 'free_shipping=true&amp;' or '') + 'price_range=0_500'" 
                                               class="text-decoration-none small"
                                               t-att-style="'color: #007bff; font-weight: bold;' if current_filters.get('price_range') == '0_500' else 'color: #6c757d;'">
                                                Hasta $500 (<t t-esc="price_ranges.get('0_500', 0)"/>)
                                            </a>
                                        </div>
                                        <div class="mb-1">
                                            <a t-att-href="'/subcategory?' + (current_filters.get('category_id') and ('category_id=' + str(current_filters.get('category_id')) + '&amp;') or '') + (current_filters.get('subcategory_id') and ('subcategory_id=' + str(current_filters.get('subcategory_id')) + '&amp;') or '') + (current_filters.get('brand_id') and ('brand_id=' + str(current_filters.get('brand_id')) + '&amp;') or '') + (current_filters.get('free_shipping') and 'free_shipping=true&amp;' or '') + 'price_range=500_1000'" 
                                               class="text-decoration-none small"
                                               t-att-style="'color: #007bff; font-weight: bold;' if current_filters.get('price_range') == '500_1000' else 'color: #6c757d;'">
                                                De $500 a $1000 (<t t-esc="price_ranges.get('500_1000', 0)"/>)
                                            </a>
                                        </div>
                                        <div class="mb-1">
                                            <a t-att-href="'/subcategory?' + (current_filters.get('category_id') and ('category_id=' + str(current_filters.get('category_id')) + '&amp;') or '') + (current_filters.get('subcategory_id') and ('subcategory_id=' + str(current_filters.get('subcategory_id')) + '&amp;') or '') + (current_filters.get('brand_id') and ('brand_id=' + str(current_filters.get('brand_id')) + '&amp;') or '') + (current_filters.get('free_shipping') and 'free_shipping=true&amp;' or '') + 'price_range=1000_plus'" 
                                               class="text-decoration-none small"
                                               t-att-style="'color: #007bff; font-weight: bold;' if current_filters.get('price_range') == '1000_plus' else 'color: #6c757d;'">
                                                Más de $1000 (<t t-esc="price_ranges.get('1000_plus', 0)"/>)
                                            </a>
                                        </div>
                                    </div>
                                </div>

                                <!-- Discounts -->
                                <div class="filter-section mb-4" t-if="discount_tags">
                                    <h6 class="mb-2">Descuentos</h6>
                                    <div class="discount-options">
                                        <t t-foreach="discount_tags" t-as="tag" t-key="tag.id">
                                            <div class="mb-1">
                                                <a t-att-href="'/subcategory?' + (current_filters.get('category_id') and ('category_id=' + str(current_filters.get('category_id')) + '&amp;') or '') + (current_filters.get('subcategory_id') and ('subcategory_id=' + str(current_filters.get('subcategory_id')) + '&amp;') or '') + (current_filters.get('brand_id') and ('brand_id=' + str(current_filters.get('brand_id')) + '&amp;') or '') + (current_filters.get('free_shipping') and 'free_shipping=true&amp;' or '') + 'discount_id=' + str(tag.id)" 
                                                   class="text-decoration-none small"
                                                   t-att-style="'color: #007bff; font-weight: bold;' if current_filters.get('discount_id') == tag.id else 'color: #6c757d;'">
                                                    <t t-esc="tag.name"/> - <t t-esc="tag.discount_percentage"/>% OFF (<t t-esc="discount_tag_counts.get(tag.id, 0)"/>)
                                                </a>
                                            </div>
                                        </t>
                                    </div>
                                </div>

                                <!-- Promotion Type -->
                                <div class="filter-section mb-4" t-if="promotion_tags">
                                    <h6 class="mb-2">Tipo de promoción</h6>
                                    <div class="promotion-options">
                                        <t t-foreach="promotion_tags" t-as="tag" t-key="tag.id">
                                            <div class="mb-1">
                                                <a t-att-href="'/subcategory?' + (current_filters.get('category_id') and ('category_id=' + str(current_filters.get('category_id')) + '&amp;') or '') + (current_filters.get('subcategory_id') and ('subcategory_id=' + str(current_filters.get('subcategory_id')) + '&amp;') or '') + (current_filters.get('brand_id') and ('brand_id=' + str(current_filters.get('brand_id')) + '&amp;') or '') + (current_filters.get('free_shipping') and 'free_shipping=true&amp;' or '') + 'promotion_id=' + str(tag.id)" 
                                                   class="text-decoration-none small"
                                                   t-att-style="'color: #007bff; font-weight: bold;' if current_filters.get('promotion_id') == tag.id else 'color: #6c757d;'">
                                                    <t t-esc="tag.name"/> (<t t-esc="promotion_tag_counts.get(tag.id, 0)"/>)
                                                </a>
                                            </div>
                                        </t>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Área de Productos -->
                            <div class="products-list">
                                <t t-foreach="period_products" t-as="product_data" t-key="product_data['product'].id">
                                    <div class="product-list-item mb-3 p-3" style="border: 1px solid #dee2e6; border-radius: 8px;">
                                        <div class="row align-items-center">
                                            <!-- Imagen del producto -->
                                            <div class="col-3">
                                                <img t-att-src="'/web/image/product.template/%s/image_1024' % product_data['product'].id" 
                                                     class="img-fluid" alt="Product Image" style="max-height: 150px; object-fit: contain;"/>
                                            </div>
                                            <!-- Detalles del producto -->
                                            <div class="col-6">
                                                <h5 class="mb-2" t-field="product_data['product'].name"/>
                                                <p class="text-muted mb-2" t-field="product_data['product'].description_sale"/>
                                                <div class="text-success" t-if="product_data['product'].free_shipping">Envío gratis</div>
                                            </div>
                                            <!-- Precio y descuento -->
                                            <div class="col-3 text-end">
                                                <t t-if="product_data['product'].discount_percentage > 0 or product_data['product'].fixed_discount > 0">
                                                    <div class="text-decoration-line-through text-muted mb-1">
                                                        <span t-esc="product_data['product'].list_price" t-options="{'widget': 'monetary', 'display_currency': website.currency_id}"/>
                                                    </div>
                                                    <div class="h5 mb-2 text-danger">
                                                        <span t-esc="product_data['product'].discounted_price" t-options="{'widget': 'monetary', 'display_currency': website.currency_id}"/>
                                                    </div>
                                                    <div class="badge bg-danger">
                                                        <t t-if="product_data['product'].discount_percentage > 0">
                                                            <t t-esc="product_data['product'].discount_percentage"/>% OFF
                                                        </t>
                                                        <t t-else="">
                                                            $<t t-esc="product_data['product'].fixed_discount"/> OFF
                                                        </t>
                                                    </div>
                                                </t>
                                                <t t-else="">
                                                    <div class="h5 mb-2">
                                                        <span t-esc="product_data['product'].list_price" t-options="{'widget': 'monetary', 'display_currency': website.currency_id}"/>
                                                    </div>
                                                </t>
                                            </div>
                                        </div>
                                    </div>
                                </t>
                            </div>
                    </div>
                </div>
            </div>
            
            <!-- JavaScript -->
            <script type="text/javascript">
                //<![CDATA[
                function updateFilters() {
                    const filters = {};
                    
                    const categorySelect = document.getElementById('category-select');
                    if (categorySelect && categorySelect.value) {
                        filters.category_id = categorySelect.value;
                    }
                    
                    const subcategorySelect = document.getElementById('subcategory-select');
                    if (subcategorySelect && subcategorySelect.value) {
                        filters.subcategory_id = subcategorySelect.value;
                    }
                    
                    const freeShipping = document.getElementById('free-shipping');
                    if (freeShipping && freeShipping.checked) {
                        filters.free_shipping = true;
                    }
                    
                    const urlParams = new URLSearchParams();
                    Object.keys(filters).forEach(key => {
                        if (filters[key]) {
                            urlParams.append(key, filters[key]);
                        }
                    });
                    
                    const currentUrl = window.location.pathname;
                    const newUrl = urlParams.toString() ? currentUrl + '?' + urlParams.toString() : currentUrl;
                    window.location.href = newUrl;
                }
                
                document.addEventListener('DOMContentLoaded', function() {
                    const categorySelect = document.getElementById('category-select');
                    if (categorySelect) {
                        categorySelect.addEventListener('change', function() {
                            const categoryId = this.value;
                            const subcategorySelect = document.getElementById('subcategory-select');
                            
                            if (categoryId) {
                                subcategorySelect.style.display = 'block';
                            } else {
                                subcategorySelect.style.display = 'none';
                                subcategorySelect.value = '';
                            }
                        });
                    }
                });
                //]]>
            </script>
        </t>
    </template>
</odoo>