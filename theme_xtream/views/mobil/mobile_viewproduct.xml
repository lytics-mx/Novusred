<odoo>
    <template id="website_view_product_xtream_mobile" inherit_id="website_view_product_xtream">
        <xpath expr="//div[@id='wrap']" position="inside">
            <div class="d-block d-md-none w-100 px-0 py-2" style="font-family: 'Montserrat', Arial, sans-serif; width:100%; max-width:100%; margin:0; padding-top:0.5rem; padding-bottom:0.5rem;">
                <!-- Estado del producto -->
                <t t-set="pdate" t-value="product.create_date"/>
                <t t-set="now" t-value="datetime.datetime.now()"/>
                <div t-if="pdate and pdate.year == now.year and pdate.month == now.month" style="font-size:12px; color:#888;">
                    Nuevo
                </div>                <!-- Título -->
                <div style="font-size:18px; font-weight:600; margin-bottom:4px;">
                    <t t-esc="product.name and (product.name[:40] + '' if len(product.name) > 40 else product.name)"/>
                </div>
                <div style="font-size:13px; color:#888; margin-bottom:4px;">
                    <t t-if="product.product_model">
                        <t t-esc="product.product_model"/>
                    </t>
                    <t t-elif="product.default_code">
                        <t t-esc="product.default_code"/>
                    </t>
                </div>
                <!-- Estrellas -->
                <div class="mb-2">
                    <span style="color:#0057ff; font-size:20px;">&#9733;&#9733;&#9733;&#9733;</span>
                    <span style="color:#ccc; font-size:20px;">&#9733;</span>
                </div>
                <!-- Slider de imágenes -->
                <div class="mb-2 text-center">
                    <t t-set="pcount" t-value="1 + (len(product.product_image_ids) if product.product_image_ids else 0)"/>
                    <span style="font-size:11px; background:#f2f2f2; border-radius:8px; padding:2px 8px;">
                        <t t-esc="1"/> / <t t-esc="pcount"/>
                    </span>
                </div>
                <div class="mb-3 text-center">
                    <!-- Imagen principal primero -->
                    <img id="main-product-img"
                         t-att-src="'/web/image/product.template/' + str(product.id) + '/image_1920'"
                         alt="Imagen principal"
                         style="max-width:100%; border-radius:10px; object-fit:contain;"/>
                </div>
                <!-- Imágenes adicionales (si existen) -->
                <t t-if="product.product_image_ids">
                    <div class="d-flex justify-content-center gap-2 mb-3" style="overflow:auto; padding-bottom:4px;">
                        <t t-foreach="product.product_image_ids" t-as="img">
                            <img t-att-src="'/web/image/product.image/' + str(img.id) + '/image_1920'"
                                 t-att-alt="img.name or 'Imagen adicional'"
                                 class="img-thumbnail thumb-mini"
                                 t-att-data-img="'/web/image/product.image/' + str(img.id) + '/image_1920'"
                                 style="height:64px; width:auto; cursor:pointer; border-radius:8px;"/>
                        </t>
                    </div>
                </t>
                <!-- Precio y descuento -->
                <div class="card-body mobile-card-body" style="text-align:left;">
                    <!-- <t t-if="product.product_tag_ids">
                        <div class="d-flex justify-content-start mb-2 mobile-badge-container">
                            <span class="badge bg-primary mobile-badge" style="border-radius: 0; text-transform: uppercase;">
                                <t t-esc="product.product_tag_ids[0].name"/>
                            </span>
                        </div>
                    </t> -->
                    <t t-if="product.discounted_price &lt; product.list_price">
                        <div class="mt-0 mobile-discount-amount">
                            <span class="text-muted" style="font-size: 16px; text-decoration: line-through;">
                                $<t t-esc="'{:,}'.format(int(product.list_price))" />
                            </span>
                        </div>
                        <div class="d-flex align-items-center justify-content-start mobile-price-container" style="text-align:left; gap:8px;">
                            <span class="text-dark fw-bold mobile-main-price" style="font-size: 28px; color: #000; font-weight: bold;">
                                $<t t-esc="'{:,}'.format(int(product.discounted_price))" />
                            </span>
                            <t t-if="product.discount_percentage or product.fixed_discount">
                                <span class="mobile-discount" style="font-size: 16px; font-weight: normal; color: #FF5207; margin-left:8px;">
                                    <t t-if="product.discount_percentage">
                                        <t t-esc="int(product.discount_percentage)" />% OFF
                                    </t>
                                    <t t-elif="product.fixed_discount">
                                        -$<t t-esc="'{:,}'.format(int(product.fixed_discount))" /> MXN
                                    </t>
                                </span>
                            </t>
                        </div>
                        <t t-if="product.list_price and product.discounted_price and (product.list_price - product.discounted_price) &gt; 0">
                            <div class="mt-0 mobile-discount-amount">
                                <span class="text-muted">
                                    $<t t-esc="'{:,}'.format(int(product.list_price - product.discounted_price))" /> descuento
                                </span>
                            </div>
                        </t>
                    </t>
                    <t t-elif="product.list_price">
                        <span class="fw-bold d-block mobile-main-price" style="text-align:left;">
                            $<t t-esc="'{:,}'.format(int(product.list_price))" />
                        </span>
                    </t>
                </div>
                <!-- Envío gratis -->
                <t t-if="product.free_shipping">
                    <div class="mt-0 mobile-shipping d-flex justify-content-start" style="text-align:left;">
                        <span class="text-orange mobile-shipping-text">
                            Envío gratis
                        </span>
                    </div>
                </t>
                <!-- Detalles -->
                <div class="text-start" style="font-size:13px; color:#444; text-align:left;">
                    <div>Modelo: <t t-esc="product.default_code"/></div>
                    <div>Marca: <t t-esc="product.brand_type_id.name"/></div>
                    <div>Disponible:</div>
                </div>
                <!-- Selector de cantidad -->
                <div class="my-3">
                    <button type="button" class="btn btn-light w-100" id="qty-toggle-btn" style="border-radius:8px; border:1px solid #e0e0e0; text-align:left; display:flex; align-items:center; justify-content:space-between; padding:0.5rem;">
                        <span id="qty-toggle-text">
                            <span id="qty-toggle-value"></span>
                            <span id="qty-available-text" style="color:#888; font-size:14px; margin-left:6px;"></span>
                        </span>
                        <span class="float-end">&gt;</span>
                    </button>

                    <div id="mobile-qty-container" style="display:none; margin-top:8px; align-items:center;">
                        <div style="width:100%; display:flex; align-items:center; justify-content:center; gap:8px;">
                            <button type="button" class="btn" id="qty-minus" style="min-width:36px; height:36px; font-size:20px; padding:0; background:transparent; border:1px solid #e0e0e0; color:#222; border-radius:6px;">-</button>
                            <input id="qty-input" type="number" name="add_qty" value="1" min="1" t-att-max="product.qty_available"
                                class="form-control text-center"
                                style="width:3.5em; min-width:48px; max-width:4.5em; padding:0 4px; border:1px solid #e0e0e0; box-shadow:none; background:transparent; outline:none; font-size:16px; border-radius:6px;"
                                onwheel="return false;"
                                inputmode="numeric"
                                maxlength="4"
                            />
                            <button type="button" class="btn" id="qty-plus" style="min-width:36px; height:36px; font-size:20px; padding:0; background:transparent; border:1px solid #e0e0e0; color:#222; border-radius:6px;">+</button>
                        </div>
                    </div>
                </div>

                <t t-jquery="body" t-operation="append">
                    <style>
                        /* Oculta las flechas de los inputs type number en todos los navegadores */
                        input[type=number]::-webkit-inner-spin-button, 
                        input[type=number]::-webkit-outer-spin-button { 
                            -webkit-appearance: none; 
                            margin: 0; 
                        }
                        input[type=number] {
                            -moz-appearance: textfield;
                        }
                        /* Ajusta el ancho del input según el número de dígitos */
                        #qty-input {
                            width: 3.5em !important;
                            min-width: 48px !important;
                            max-width: 4.5em !important;
                            text-align: center;
                        }
                    </style>
                </t>

                <t t-jquery="body" t-operation="append">
                    <script type="text/javascript"><![CDATA[
                        document.addEventListener('DOMContentLoaded', function() {
                            var toggleBtn = document.getElementById('qty-toggle-btn');
                            var container = document.getElementById('mobile-qty-container');
                            var qtyInput = document.getElementById('qty-input');
                            var minusBtn = document.getElementById('qty-minus');
                            var plusBtn = document.getElementById('qty-plus');
                            var toggleValue = document.getElementById('qty-toggle-value');
                            var availableText = document.getElementById('qty-available-text');

                            if (!toggleBtn || !container || !qtyInput) return;

                            var max = parseInt(qtyInput.getAttribute('max')) || 9999;

                            function updateToggleText() {
                                // Always hide the selected quantity number and show only available stock
                                toggleValue.textContent = '';
                                availableText.textContent = '(' + max + ' disponibles)';
                            }

                            toggleBtn.addEventListener('click', function() {
                                var isOpen = container.style.display === 'flex' || container.style.display === 'block';
                                container.style.display = isOpen ? 'none' : 'flex';
                                if (!isOpen) {
                                    // show -> focus input
                                    qtyInput.focus();
                                    // select text for quick typing on mobile
                                    try { qtyInput.select(); } catch (e) {}
                                }
                            });

                            // Quantity control logic
                            minusBtn && minusBtn.addEventListener('click', function() {
                                var val = parseInt(qtyInput.value) || 1;
                                if (val > 1) {
                                    qtyInput.value = val - 1;
                                    updateToggleText();
                                }
                            });
                            plusBtn && plusBtn.addEventListener('click', function() {
                                var val = parseInt(qtyInput.value) || 1;
                                if (val < max) {
                                    qtyInput.value = val + 1;
                                    updateToggleText();
                                }
                            });
                            qtyInput.addEventListener('input', function() {
                                var val = parseInt(qtyInput.value) || 1;
                                if (val < 1) val = 1;
                                if (val > max) val = max;
                                qtyInput.value = val;
                                updateToggleText();
                            });

                            // prevent mouse wheel changing number on focused input
                            qtyInput.addEventListener('wheel', function(e){ e.preventDefault(); });

                            // initialize
                            updateToggleText();

                            // Update hidden cart inputs when forms submit
                            var addToCartForm = document.getElementById('add-to-cart-form-mobile');
                            var buyNowForm = document.getElementById('buy-now-form-mobile');
                            if (addToCartForm) {
                                addToCartForm.addEventListener('submit', function() {
                                    var cartQty = document.getElementById('cart-qty');
                                    if (cartQty) cartQty.value = qtyInput.value;
                                });
                            }
                            if (buyNowForm) {
                                buyNowForm.addEventListener('submit', function() {
                                    var buyQty = document.getElementById('buy-qty');
                                    if (buyQty) buyQty.value = qtyInput.value;
                                });
                            }
                        });
                    ]]></script>
                </t>
                <!-- Métodos de pago -->
                <div style="font-size:13px; color:#888;">Puedes pagar con:</div>
                <div class="d-flex flex-wrap align-items-center mb-3" style="gap:8px;">
                    <img src="/theme_xtream/static/src/img/product-img/pagomobil.png" alt="Pago móvil" style="height:50px;"/>
                </div>
                <!-- Botones -->
                <form id="add-to-cart-form-mobile" action="/shop/cart/update" method="POST" class="js_website_sale w-100">
                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()" t-nocache="The csrf token must always be up to date."/>
                    <input type="hidden" name="product_id" t-att-value="product.product_variant_id.id"/>
                    <input type="hidden" name="add_qty" id="cart-qty"/>
                    <button type="submit"
                        class="btn w-100 mb-2"
                        style="height:48px; border-radius:8px; background:#2979ff; color:#fff; border:none; font-weight:600; font-family:inherit; letter-spacing:0.5px;"
                        onclick="document.getElementById('cart-qty').value = (document.getElementById('qty-input') &amp;&amp; document.getElementById('qty-input').value) ? document.getElementById('qty-input').value : 1;">
                        <span style="font-size:16px; font-weight:600;">Agregar al carrito</span>
                    </button>
                </form>

                <form id="buy-now-form-mobile" action="/shop/cart/update" method="POST" class="w-100">
                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()" t-nocache="The csrf token must always be up to date."/>
                    <input type="hidden" name="product_id" t-att-value="product.product_variant_id.id"/>
                    <input type="hidden" name="add_qty" id="buy-qty"/>
                    <button type="submit"
                        class="btn w-100"
                        id="buy-now-btn-mobile"
                        style="height:48px; border-radius:8px; background:#82b1ff; color:#1757e6; border:none; font-weight:600; font-family:inherit; letter-spacing:0.5px;"
                        onclick="document.getElementById('buy-qty').value = (document.getElementById('qty-input') &amp;&amp; document.getElementById('qty-input').value) ? document.getElementById('qty-input').value : 1;">
                        <span style="font-size:16px; font-weight:600;">Comprar</span>
                    </button>
                </form>
                                <t t-if="product.accessory_product_ids">
                                    <hr/>

                                    <div class="row" style="padding:18px; margin-bottom:24px;">
                                        <!-- Accesorios a la izquierda -->
                                        <div class="col-12 col-md-9">
                                            <h5 style="font-weight:600; margin-bottom:12px; font-size:22px; text-align:left;">Productos que podrían interesarte</h5>
                                            <t t-set="acc_list" t-value="[acc for acc in product.accessory_product_ids if acc.product_variant_id.id != product.product_variant_id.id]"/>
                                            <t t-set="acc_count" t-value="len(acc_list)"/>
                                            <t t-if="acc_count > 3">
                                                <div id="accessory-carousel" class="carousel slide" data-bs-ride="carousel">
                                                    <div class="carousel-inner">
                                                        <t t-foreach="range(0, acc_count, 3)" t-as="idx">
                                                            <div t-attf-class="carousel-item #{'active' if idx == 0 else ''}">
                                                                <div class="d-flex flex-nowrap align-items-stretch justify-content-center" style="gap:8px;">                                                                    
                                                                    <t t-foreach="acc_list[idx:idx+3]" t-as="acc" t-index="acc_idx" t-key="acc.id">
                                                                        <div class="d-flex flex-column align-items-center" style="position:relative;">
                                                                            <div t-attf-class="card shadow-sm accessory-card accessory-card-100 #{'not-last' if acc_idx != (min(2, acc_count-idx-1)) else ''}" style="border-radius: 10px; overflow: hidden; width:120px; min-width:120px; max-width:120px;">
                                                                                <div style="position: absolute; z-index: 2; left: 8px; top: 8px;">
                                                                                    <input type="checkbox" name="bundle_product_ids[]" t-att-value="acc.product_variant_id.id" class="bundle-checkbox custom-bundle-checkbox" style="width:30px; height:30px; border-radius:9px; border:1px solid #888; background:#f8f8f8;"/>
                                                                                </div>
                                                                                <t t-if="acc.product_tmpl_id">
                                                                                    <a t-att-href="acc.product_tmpl_id.website_url">
                                                                                        <div class="image-container" style="position: relative; overflow: hidden; padding-top: 100%;">
                                                                                            <img t-att-src="'/web/image/product.template/' + str(acc.product_tmpl_id.id) + '/image_1920'"
                                                                                                 class="card-img-top accessory-img"
                                                                                                 style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; padding: 10px;" />
                                                                                        </div>
                                                                                    </a>
                                                                                </t>
                                                                                <t t-else="">
                                                                                    <a t-att-href="acc.website_url">
                                                                                        <div class="image-container" style="position: relative; overflow: hidden; padding-top: 100%;">
                                                                                            <img t-att-src="'/web/image/product.template/' + str(acc.id) + '/image_1920'"
                                                                                                 class="card-img-top accessory-img"
                                                                                                 style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; padding: 10px;" />
                                                                                        </div>
                                                                                    </a>
                                                                                </t>
                                                                                <div class="card-body accessory-card-body accessory-card-100" style="text-align: left; padding: 4px 2px 2px 2px;">
                                                                                    <t t-if="acc.product_tag_ids">
                                                                                        <div class="d-flex justify-content-start mb-2 accessory-badge-container">
                                                                                            <span class="badge bg-primary accessory-badge" style="border-radius: 0; text-transform: uppercase; font-size:10px; padding:2px 4px; max-width:90px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                                                                                                <t t-esc="acc.product_tag_ids[0].name"/>
                                                                                            </span>
                                                                                        </div>
                                                                                    </t>
                                                                                    <t t-if="acc.discounted_price &lt; acc.list_price">
                                                                                        <div class="mt-0 accessory-discount-amount">
                                                                                            <span style="font-size: 9px;">
                                                                                                $<t t-esc="'{:,}'.format(int(acc.list_price or 0))" />
                                                                                            </span>
                                                                                        </div>
                                                                                        <div class="d-flex align-items-center accessory-price-container" style="gap: 2px;">
                                                                                            <span class="text-dark fw-bold accessory-main-price" style="font-size: 10px; color: #000; font-weight: bold;">
                                                                                                $<t t-esc="'{:,}'.format(int(acc.discounted_price or 0))" />
                                                                                            </span>
                                                                                            <t t-if="acc.discount_percentage or acc.fixed_discount">
                                                                                                <span class="accessory-discount" style="font-size: 9px; font-weight: normal; color: #FF5207; margin-left: 2px;">
                                                                                                    <t t-if="acc.discount_percentage">
                                                                                                        <t t-esc="int(acc.discount_percentage)" />% OFF
                                                                                                    </t>
                                                                                                    <t t-elif="acc.fixed_discount">
                                                                                                        -$<t t-esc="'{:,}'.format(int(acc.fixed_discount))" /> MXN
                                                                                                    </t>
                                                                                                </span>
                                                                                            </t>
                                                                                        </div>
                                                                                        <t t-if="acc.list_price and acc.discounted_price and (acc.list_price - acc.discounted_price) &gt; 0">
                                                                                            <div class="mt-0 accessory-discount-amount">
                                                                                                <span style="font-size: 12px;">
                                                                                                    $<t t-esc="'{:,}'.format(int(acc.list_price - acc.discounted_price))" /> descuento
                                                                                                </span>
                                                                                            </div>
                                                                                        </t>
                                                                                    </t>
                                                                                    <t t-elif="acc.list_price">
                                                                                        <span class="fw-bold d-block accessory-main-price" style="font-size: 16px;">
                                                                                            $<t t-esc="'{:,}'.format(int(acc.list_price or 0))" />
                                                                                        </span>
                                                                                    </t>
                                                                                    <t t-if="acc.free_shipping">
                                                                                        <div class="mt-0 accessory-shipping">
                                                                                            <span class="text-orange accessory-shipping-text" style="font-size: 12px;">
                                                                                                Envío gratis
                                                                                            </span>
                                                                                        </div>
                                                                                    </t>
                                                                                    <h6 class="card-title mb-2" style="font-size: 13px; line-height: 1.1; max-height: 2.2em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; width:100px; text-overflow: clip;">
                                                                                        <t t-esc="acc.name" />
                                                                                    </h6>
                                                                                </div>
                                                                                <t t-if="acc_idx != (min(2, acc_count-idx-1))">
                                                                                    <span style="position: absolute; right: -20px; top: 50%; transform: translateY(-50%); font-size: 24px; font-weight: bold; color: #888; line-height: 1; pointer-events: none;">+</span>
                                                                                </t>
                                                                            </div>
                                                                        </div>
                                                                    </t>
                                                                </div>
                                                            </div>
                                                        </t>
                                                    </div>
                                                    <button class="carousel-control-prev" type="button" data-bs-target="#accessory-carousel" data-bs-slide="prev"
                                                        style="z-index: 10; width: 48px; height: 48px; top: 50%; left: 0; transform: translateY(-50%); position: absolute; background: rgba(255,255,255,0.7); border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center;">
                                                        <span aria-hidden="true" style="font-size: 38px; color: #222; display: flex; align-items: center;">
                                                            <svg width="32" height="32" viewBox="0 0 48 48" fill="none" style="display:block;" xmlns="http://www.w3.org/2000/svg">
                                                                <polyline points="32,8 16,24 32,40" stroke="#222" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                                                                <polyline points="40,8 24,24 40,40" stroke="#222" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                                                            </svg>
                                                        </span>
                                                        <span class="visually-hidden">Anterior</span>
                                                    </button>
                                                    <button class="carousel-control-next" type="button" data-bs-target="#accessory-carousel" data-bs-slide="next"
                                                        style="z-index: 10; width: 48px; height: 48px; top: 50%; right: 0; transform: translateY(-50%); position: absolute; background: rgba(255,255,255,0.7); border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center;">
                                                        <span aria-hidden="true" style="font-size: 38px; color: #222; display: flex; align-items: center;">
                                                            <svg width="32" height="32" viewBox="0 0 48 48" fill="none" style="display:block;" xmlns="http://www.w3.org/2000/svg">
                                                                <polyline points="16,8 32,24 16,40" stroke="#222" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                                                                <polyline points="8,8 24,24 8,40" stroke="#222" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                                                            </svg>
                                                        </span>
                                                        <span class="visually-hidden">Siguiente</span>
                                                    </button>
                                                </div>
                                                <t t-jquery="body" t-operation="append">
                                                    <script type="text/javascript"><![CDATA[
                                                        document.addEventListener('DOMContentLoaded', function() {
                                                            if (window.bootstrap && window.bootstrap.Carousel) {
                                                                var el = document.getElementById('accessory-carousel');
                                                                if (el) {
                                                                    new window.bootstrap.Carousel(el, {interval: 0, wrap: true});
                                                                }
                                                            }
                                                        });
                                                    ]]></script>
                                                </t>
                                            </t>
                                            <t t-else="">
                                                <div class="d-flex flex-nowrap align-items-stretch" style="gap:48px;">
                                                    <t t-foreach="acc_list" t-as="acc" t-index="acc_idx" t-key="acc.id">
                                                        <div class="d-flex flex-column align-items-center" style="position:relative;">
                                                            <div class="card shadow-sm accessory-card accessory-card-100" style="border-radius: 10px; overflow: hidden; width:150px; min-width:150px; max-width:150px;">
                                                                <div style="position: absolute; z-index: 2; left: 8px; top: 8px;">
                                                                    <input type="checkbox" name="bundle_product_ids[]" t-att-value="acc.product_variant_id.id" class="bundle-checkbox custom-bundle-checkbox" style="width:30px; height:30px; border-radius:9px; border:1px solid #888; background:#f8f8f8;"/>
                                                                </div>
                                                                <t t-if="acc.product_tmpl_id">
                                                                    <a t-att-href="acc.product_tmpl_id.website_url">
                                                                        <div class="image-container" style="position: relative; overflow: hidden; padding-top: 100%;">
                                                                            <img t-att-src="'/web/image/product.template/' + str(acc.product_tmpl_id.id) + '/image_1920'"
                                                                                 class="card-img-top accessory-img"
                                                                                 style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; padding: 10px;" />
                                                                        </div>
                                                                    </a>
                                                                </t>
                                                                <t t-else="">
                                                                    <a t-att-href="acc.website_url">
                                                                        <div class="image-container" style="position: relative; overflow: hidden; padding-top: 100%;">
                                                                            <img t-att-src="'/web/image/product.template/' + str(acc.id) + '/image_1920'"
                                                                                 class="card-img-top accessory-img"
                                                                                 style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; padding: 10px;" />
                                                                        </div>
                                                                    </a>
                                                                </t>
                                                                <div class="card-body accessory-card-body accessory-card-100" style="text-align: left; padding: 4px 2px 2px 2px;">
                                                                    <t t-if="acc.product_tag_ids">
                                                                        <div class="d-flex justify-content-start mb-2 accessory-badge-container">
                                                                            <span class="badge bg-primary accessory-badge" style="border-radius: 0; text-transform: uppercase; font-size:10px; padding:2px 4px; max-width:90px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                                                                                <t t-esc="acc.product_tag_ids[0].name"/>
                                                                            </span>
                                                                        </div>
                                                                    </t>
                                                                    <t t-if="acc.discounted_price &lt; acc.list_price">
                                                                        <div class="mt-0 accessory-discount-amount">
                                                                            <span style="font-size: 9px;">
                                                                                $<t t-esc="'{:,}'.format(int(acc.list_price or 0))" />
                                                                            </span>
                                                                        </div>
                                                                        <div class="d-flex align-items-center accessory-price-container" style="gap: 2px;">
                                                                            <span class="text-dark fw-bold accessory-main-price" style="font-size: 10px; color: #000; font-weight: bold;">
                                                                                $<t t-esc="'{:,}'.format(int(acc.discounted_price or 0))" />
                                                                            </span>
                                                                            <t t-if="acc.discount_percentage or acc.fixed_discount">
                                                                                <span class="accessory-discount" style="font-size: 9px; font-weight: normal; color: #FF5207; margin-left: 2px;">
                                                                                    <t t-if="acc.discount_percentage">
                                                                                        <t t-esc="int(acc.discount_percentage)" />% OFF
                                                                                    </t>
                                                                                    <t t-elif="acc.fixed_discount">
                                                                                        -$<t t-esc="'{:,}'.format(int(acc.fixed_discount))" /> MXN
                                                                                    </t>
                                                                                </span>
                                                                            </t>
                                                                        </div>
                                                                        <t t-if="acc.list_price and acc.discounted_price and (acc.list_price - acc.discounted_price) &gt; 0">
                                                                            <div class="mt-0 accessory-discount-amount">
                                                                                <span style="font-size: 12px; color: #333;">
                                                                                    $<t t-esc="'{:,}'.format(int(acc.list_price - acc.discounted_price))" /> descuento
                                                                                </span>
                                                                            </div>
                                                                        </t>
                                                                    </t>
                                                                    <t t-elif="acc.list_price">
                                                                        <span class="fw-bold d-block accessory-main-price" style="font-size: 16px;">
                                                                            $<t t-esc="'{:,}'.format(int(acc.list_price or 0))" />
                                                                        </span>
                                                                    </t>
                                                                    <t t-if="acc.free_shipping">
                                                                        <div class="mt-0 accessory-shipping">
                                                                            <span class="text-orange accessory-shipping-text" style="font-size: 12px;">
                                                                                Envío gratis
                                                                            </span>
                                                                        </div>
                                                                    </t>
                                                                    <h6 class="card-title mb-2" style="font-size: 13px; line-height: 1.1; max-height: 2.2em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; text-transform: uppercase; width:100px;">
                                                                        <t t-esc="acc.name" />
                                                                    </h6>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </t>
                                                </div>
                                            </t>
                                        </div>


                                        <!-- Selección y precio a la derecha (sin mostrar el card del producto principal, solo lógica de precio) -->
                                        <div class="col-12 col-md-3 d-flex flex-column align-items-center justify-content-center" style="padding-top: 30px;">
                                            <form id="bundle-form" action="/shop/cart/update_bundle" method="POST" style="width:100%; max-width:320px;">
                                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()" t-nocache="The csrf token must always be up to date."/>
                                                <input type="hidden" name="add_qty" id="bundle-qty" value="1"/>
                                                <input type="hidden" name="product_id" t-att-value="product.product_variant_id.id"/>
                                        
                                                <!-- Precio total -->
                                                <div id="bundle-total-container" style="margin-bottom: 12px; font-size: 20px; font-weight: bold; color: #000;">
                                                    Precio total: <span id="bundle-total" style="font-size:20px;">$0.00</span>
                                                </div>
                                        
                                                <!-- Botón para agregar al carrito -->
                                                <button type="submit" class="btn" id="bundle-add-to-cart" style="width:100%; height:48px; border-radius:6px; background:#4285f4; color:#fff; border:none; font-weight:500; font-size:18px; letter-spacing:0.5px; font-family:'Questrial', sans-serif;">
                                                    Agregar al carrito
                                                </button>
                                        
                                                <!-- Botón para comprar directamente -->
                                                <button type="button" class="btn" id="bundle-buy-now" style="width:100%; height:48px; border-radius:6px; background:#a8ccff; color:#1757e6; border:none; font-weight:500; font-size:18px; letter-spacing:0.5px; font-family:'Questrial', sans-serif; margin-top: 10px;">
                                                    Comprar
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                    <script type="text/javascript">
                                    document.addEventListener('DOMContentLoaded', function() {
                                        var bundleForm = document.getElementById('bundle-form');
                                        var totalPriceElement = document.getElementById('bundle-total'); // Elemento para mostrar el precio total
                                        var buyNowButton = document.getElementById('bundle-buy-now'); // Botón "Comprar"

                                        // Función para obtener el precio de un producto
                                        function getPriceFromText(text) {
                                            return parseFloat((text || '').replace(/[^0-9.]/g, '')) || 0;
                                        }

                                        // Función para obtener el precio raíz (descuento si existe, si no, list_price)
                                        function getRootPrice() {
                                            var discounted = document.querySelector('.col-12.col-md-4 .new-main-price');
                                            if (discounted) {
                                                return getPriceFromText(discounted.textContent);
                                            }
                                            var list = document.querySelector('.col-12.col-md-4 .fw-bold.d-block.new-main-price');
                                            if (list) {
                                                return getPriceFromText(list.textContent);
                                            }
                                            return 0;
                                        }

                                        // Función para actualizar el precio total
                                        function updateTotal() {
                                            var total = getRootPrice();
                                            // Sumar los accesorios seleccionados
                                            document.querySelectorAll('input[name="bundle_product_ids[]"]:checked').forEach(function(cb) {
                                                var priceDiv = cb.closest('.accessory-card')?.querySelector('.accessory-main-price') || null;
                                                if (priceDiv) {
                                                    total += getPriceFromText(priceDiv.textContent);
                                                }
                                            });
                                            if (totalPriceElement) {
                                                totalPriceElement.textContent = `$${total.toLocaleString('es-MX', { minimumFractionDigits: 2 })}`;
                                            }
                                        }

                                        // Escuchar cambios en los checkboxes
                                        document.querySelectorAll('input[name="bundle_product_ids[]"]').forEach(function(cb) {
                                            cb.addEventListener('change', updateTotal);
                                        });

                                        // Actualizar el precio total al cargar la página
                                        updateTotal();

                                        // Manejo del envío del formulario para "Agregar al carrito"
                                        bundleForm.addEventListener('submit', function(e) {
                                            e.preventDefault();
                                            var data = new FormData(bundleForm);

                                            // Agregar el producto raíz al carrito
                                            var productRoot = document.querySelector('input[name="product_id"]').value;
                                            data.append('product_id', productRoot);

                                            // Agregar todos los productos seleccionados al carrito
                                            var selectedProducts = document.querySelectorAll('input[name="bundle_product_ids[]"]:checked');
                                            if (selectedProducts.length === 0) {
                                                alert('Por favor selecciona al menos un producto para agregar al carrito.');
                                                return;
                                            }
                                            selectedProducts.forEach(function(cb) {
                                                data.append('bundle_product_ids[]', cb.value);
                                            });

                                            fetch(bundleForm.action, {
                                                method: 'POST',
                                                body: data,
                                                credentials: 'same-origin'
                                            }).then(function(response) {
                                                if (response.ok) {
                                                    window.location.href = '/shop/cart';
                                                } else {
                                                    alert('Hubo un error al agregar los productos al carrito. Por favor intenta nuevamente.');
                                                }
                                            }).catch(function(error) {
                                                console.error('Error:', error);
                                                alert('Hubo un error al procesar tu solicitud.');
                                            });
                                        });

                                        // Manejo del botón "Comprar"
                                        buyNowButton.addEventListener('click', function() {
                                            var data = new FormData(bundleForm);

                                            // Agregar el producto raíz al carrito
                                            var productRoot = document.querySelector('input[name="product_id"]').value;
                                            data.append('product_id', productRoot);

                                            // Agregar todos los productos seleccionados al carrito
                                            var selectedProducts = document.querySelectorAll('input[name="bundle_product_ids[]"]:checked');
                                            if (selectedProducts.length === 0) {
                                                alert('Por favor selecciona al menos un producto para comprar.');
                                                return;
                                            }
                                            selectedProducts.forEach(function(cb) {
                                                data.append('bundle_product_ids[]', cb.value);
                                            });

                                            fetch(bundleForm.action, {
                                                method: 'POST',
                                                body: data,
                                                credentials: 'same-origin'
                                            }).then(function(response) {
                                                if (response.ok) {
                                                    window.location.href = '/shop/checkout?try_skip_step=true';
                                                } else {
                                                    alert('Hubo un error al procesar tu compra. Por favor intenta nuevamente.');
                                                }
                                            }).catch(function(error) {
                                                console.error('Error:', error);
                                                alert('Hubo un error al procesar tu solicitud.');
                                            });
                                        });
                                    });
                                    </script>
                                </t>

                
            </div>
        </xpath>
    </template>
</odoo>